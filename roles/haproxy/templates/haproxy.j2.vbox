defaults
  retries 3
  option  redispatch
  timeout client 30s
  timeout connect 4s
  timeout server 30s
frontend kube-apiserver
  bind 0.0.0.0:6444
  mode tcp
  option tcplog
  timeout client 1h
  default_backend kube-apiserver

backend kube-apiserver
  mode tcp
  timeout server 1h
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
{% for node in groups['haproxymembers']  %}
  server {{ hostvars[node].ansible_hostname }} {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:6443 check
{% endfor %}

listen stats
  bind :9001
  mode http
  stats enable  # Enable stats page
  stats hide-version  # Hide HAProxy version
  stats realm Haproxy\ Statistics  # Title text for popup window
  stats uri /haproxy_stats  # Stats URI
  stats auth admin:admin123 # Authentication credentials
